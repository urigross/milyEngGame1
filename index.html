<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ניחוש אותיות ומילים (עם לוח שיאים)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            box-sizing: border-box;
        }
        html {
            height: 100%;
            margin: 0;
            overflow: hidden; 
        }
        body {
            font-family: 'Assistant', 'Inter', sans-serif;
            user-select: none;
            -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none;
            background-color: #f0f4f8; 
            position: relative; 
            height: 100%; 
            margin: 0;
            padding-top: 60px; 
            display: flex; 
            flex-direction: column; 
            overflow-y: auto; 
        }

        #global-nav {
            position: fixed; top: 0; left: 0; right: 0;
            background-color: #1e293b; 
            padding: 0 20px; 
            height: 60px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); z-index: 1100;
            display: flex; justify-content: center; align-items: center;
        }
        #global-nav .nav-link {
            color: #f1f5f9; text-decoration: none; padding: 8px 15px;
            margin: 0 10px; border-radius: 6px; font-weight: 600;
            transition: background-color 0.2s ease, color 0.2s ease;
        }
        #global-nav .nav-link:hover { background-color: #334155; color: white; }
        #global-nav .nav-link.active-nav { background-color: #4f46e5; color: white; }

        main { 
            display: none; 
            width: 100%; 
            flex-grow: 1; 
            overflow-y: auto; 
        }
        main.active { 
            display: block !important; 
        }

        .game-container, .mini-game-container, .leaderboard-container {
            display: flex; flex-direction: column; align-items: center; justify-content: flex-start;
            padding: 20px 20px 150px 20px; 
            width: 100%; 
        }
        .word-card {
            width: 90%; max-width: 700px; height: 300px; background-color: #ffffff;
            border-radius: 16px; box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
            display: flex; align-items: center; justify-content: center;
            margin-bottom: 20px; overflow: hidden; position: relative; 
            border: 1px solid #e2e8f0; padding: 10px; transition: box-shadow 0.3s ease-out;
        }
        .correct-word-overlay {
            position: absolute; top: 10px; left: 10px; background-color: rgba(0, 0, 0, 0.75);
            color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.9rem;
            font-weight: bold; z-index: 10; display: none; direction: ltr;
        }
        .image-display {
            max-width: 100%; max-height: 100%; object-fit: contain;
            display: none; animation-duration: 0.8s; animation-fill-mode: both;
        }
        .text-display {
            font-size: 3rem; font-weight: bold; color: #334155; text-align: center;
            padding: 20px; display: none; animation-duration: 0.8s; animation-fill-mode: both;
            max-width: 100%; word-wrap: break-word;
        }
        .text-display.fallback { font-size: 1.5rem; color: #94a3b8; font-weight: normal; }

        .guess-area {
            width: 90%; max-width: 700px; min-height: 50px; background-color: #e2e8f0;
            border-radius: 8px; display: flex; align-items: center; justify-content: center;
            flex-wrap: wrap; gap: 0.3em; padding: 10px 15px;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.06); margin-bottom: 15px; 
            cursor: pointer; direction: ltr;
        }
        .guess-slot {
            display: inline-flex; align-items: center; justify-content: center;
            width: 1.5em; height: 1.5em; font-size: 24px; font-family: monospace;
            color: #1e293b; background-color: #cbd5e1; border-radius: 4px;
            text-align: center; line-height: 1.5em;
            transition: background-color 0.2s ease, border 0.2s ease; border: 2px solid transparent;
        }
        .guess-slot.active-guess { border: 2px solid transparent; background-color: #eff6ff; animation: blinking-border 1s infinite; }
        @keyframes blinking-border { 0%, 100% { border-color: #86efac; } 50% { border-color: transparent; } }
        .guess-slot.correct { background-color: #dcfce7; border-color: #22c55e; color: #166534; animation: none; }
        .guess-slot.incorrect { background-color: #fee2e2; border-color: #ef4444; color: #991b1b; animation: none; }

        .hidden-input { position: absolute; opacity: 0; pointer-events: none; width: 1px; height: 1px; left: -9999px; }

        #keyboard-area {
            display: none; flex-direction: column; align-items: center; gap: 6px;
            width: 100%; max-width: 700px; padding: 10px; margin-top: 10px;
            position: fixed; bottom: 10px; left: 50%; transform: translateX(-50%);
            background-color: rgba(240, 244, 248, 0.9); padding: 15px; border-radius: 8px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1); z-index: 50; direction: ltr;
        }
        .keyboard-row { display: flex; justify-content: center; gap: 6px; width: 100%; }
        #keyboard-area.visible { display: flex; }
        #keyboard-area button {
            font-family: 'Inter', sans-serif; font-weight: bold; font-size: 1.1rem;
            flex-grow: 1; flex-basis: 0; max-width: 45px; height: 45px;
            border: none; border-radius: 6px; background-color: #ffffff; color: #334155;
            cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: background-color 0.15s ease, transform 0.1s ease;
            display: flex; align-items: center; justify-content: center; padding: 0 5px;
        }
        #keyboard-area button:active { background-color: #e2e8f0; transform: scale(0.95); }
        .key-highlight { background-color: #f9a8d4 !important; transition: background-color 0.3s ease; }

        #hint-button, #manual-end-game-button { 
            color: white; font-weight: bold;
            padding: 8px 16px; border-radius: 6px; margin-bottom: 15px; 
            transition: background-color 0.2s ease, opacity 0.2s ease; cursor: pointer;
            margin-right: 10px; 
        }
        #hint-button { background-color: #f59e0b; }
        #hint-button:hover:not(:disabled) { background-color: #d97706; }
        #hint-button:disabled { background-color: #a1a1aa; cursor: not-allowed; opacity: 0.7; }

        #manual-end-game-button { background-color: #ef4444; }
        #manual-end-game-button:hover { background-color: #dc2626; }
        #manual-end-game-button:disabled { background-color: #a1a1aa; cursor: not-allowed; opacity: 0.7; }

        .score-display {
            position: absolute; top: 20px; right: 20px; font-size: 40px; font-weight: bold;
            padding: 5px 10px; border-radius: 8px; background-color: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(5px); z-index: 100; opacity: 0; visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .score-display.visible { opacity: 1; visibility: visible; }
        .score-flash { animation: flashScore 0.5s ease-in-out 3; }
        @keyframes flashScore { 0%, 100% { opacity: 1; } 50% { opacity: 0.2; } }

        .prompt, #mini-game-instruction { font-size: 1.2rem; color: #475569; margin-bottom: 15px; font-weight: 500; text-align: center; }

        .overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.7);
            display: flex; align-items: center; justify-content: center; z-index: 1000;
            opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease; overflow: hidden;
        }
        .overlay.visible { opacity: 1; visibility: visible; }

        .message-box { 
            background-color: white; padding: 30px; border-radius: 16px; text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2); max-width: 90%; position: relative; z-index: 1001;
        }
        #message-overlay .message-box h2 { font-size: 1.5rem; font-weight: bold; color: #1e293b; margin-bottom: 10px; } 
        #message-overlay .message-box p { font-size: 1rem; color: #475569; margin-bottom: 15px; } 
        #message-overlay .message-box .button-group { 
            display: flex; justify-content: center; gap: 10px; margin-top: 10px;
        }
        #message-overlay .message-box button { 
            background-color: #3b82f6; color: white; padding: 10px 20px; border: none; border-radius: 8px;
            font-size: 0.9rem; font-weight: bold; cursor: pointer; transition: background-color 0.2s ease;
        }
        #message-overlay .message-box button:hover { background-color: #2563eb; }
        #leaderboard-button { background-color: #6366f1; }
        #leaderboard-button:hover { background-color: #4f46e5; }

        #checkpoint-overlay .message-box p { font-size: 1.1rem; color: #334155; margin-bottom: 25px; font-weight: 500; }
        #checkpoint-overlay .button-group { display: flex; justify-content: center; gap: 15px; }
        #checkpoint-overlay .message-box button { 
            padding: 10px 25px; border-radius: 8px; font-size: 1rem; font-weight: bold;
            cursor: pointer; transition: background-color 0.2s ease, box-shadow 0.2s ease; border: 1px solid transparent;
        }
        #checkpoint-continue-button { background-color: #10b981; color: white; }
        #checkpoint-continue-button:hover { background-color: #059669; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        #checkpoint-finish-button { background-color: #ef4444; color: white; }
        #checkpoint-finish-button:hover { background-color: #dc2626; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

        #name-prompt-overlay .message-box p { font-size: 1.1rem; color: #334155; margin-bottom: 15px; font-weight: 500; }
        #name-prompt-overlay .message-box input[type="text"] {
             display: block; width: 80%; max-width: 250px; margin: 0 auto 20px auto; padding: 10px;
             border: 1px solid #cbd5e1; border-radius: 6px; font-size: 1rem; text-align: center;
        }
        #name-prompt-overlay .message-box button { 
            background-color: #3b82f6; color: white; padding: 10px 25px; border: none; border-radius: 8px;
            font-size: 1rem; font-weight: bold; cursor: pointer; transition: background-color 0.2s ease;
        }
        #name-prompt-overlay .message-box button:hover { background-color: #2563eb; }

        #correct-word-prompt-overlay .message-box p {
            font-size: 1.2rem;
            color: #1e293b;
            line-height: 1.7;
        }
        #revealed-word-span { 
            font-weight: bold;
            color: #2563eb; 
            font-size: 1.4rem;
            direction: ltr; 
            display: inline-block; 
            margin: 0 5px;
        }


        /* Mini-Game Styles */
        #word-group-display {
            display: flex; flex-direction: column; align-items: center;
            gap: 10px; margin-bottom: 20px; width: 100%; max-width: 400px; 
        }
        .word-group-item {
            display: flex; align-items: center; background-color: #fff;
            padding: 10px 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.07);
            width: 100%; cursor: pointer; transition: background-color 0.2s ease, transform 0.1s ease;
            border: 2px solid transparent;
        }
        .word-group-item:hover { background-color: #f0f9ff; }
        .word-group-item.selected { border-color: #3b82f6; transform: scale(1.02); }
        .word-group-item.correct-mini-game { background-color: #dcfce7 !important; border-color: #22c55e !important; }
        .word-group-item.incorrect-mini-game { background-color: #fee2e2 !important; border-color: #ef4444 !important; }
        .word-group-item-number { font-weight: bold; color: #64748b; margin-left: 10px; font-size: 1.1rem; }
        .word-group-item-text { flex-grow: 1; text-align: right; font-size: 1.2rem; color: #1e293b; }
        
        #play-word-sound-button {
            background-color: #3b82f6; color: white; font-weight: bold;
            padding: 10px 20px; border-radius: 6px; margin-bottom: 20px;
            transition: background-color 0.2s ease; cursor: pointer;
        }
        #play-word-sound-button:hover { background-color: #2563eb; }
        #play-word-sound-button:disabled { background-color: #a1a1aa; cursor: not-allowed; }
        
        #mini-game-feedback { font-size: 1.1rem; font-weight: bold; min-height: 2em; margin-top: 10px; }
        .feedback-correct { color: #16a34a; }
        .feedback-incorrect { color: #dc2626; }

        /* Leaderboard Styles */
        .leaderboard-container h1 {
             font-size: 2.5rem; 
             font-weight: bold;
             color: #1e293b; 
             margin-bottom: 20px; 
             text-align: center;
        }
        #high-scores-header { 
            display: flex;
            justify-content: space-between;
            padding: 10px 15px;
            margin: 0 auto 10px auto; 
            width: 100%;
            max-width: 500px;
            background-color: #e2e8f0; 
            border-radius: 8px;
            font-weight: bold;
            color: #334155; 
        }
        #high-scores-header .header-rank { flex-basis: 15%; text-align: right; padding-right: 5px;}
        #high-scores-header .header-name { flex-basis: 55%; text-align: right; padding-right: 10px;}
        #high-scores-header .header-score { flex-basis: 30%; text-align: right; padding-right: 5px;} 

        #high-scores-list-display { 
            list-style: none;
            padding: 0;
            margin: 0 auto 30px auto; 
            width: 100%;
            max-width: 500px; 
        }
        .score-entry {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            margin-bottom: 10px;
            background-color: #f8fafc; 
            border-radius: 8px;
            font-size: 1.1rem;
            border: 1px solid #e2e8f0; 
        }
        .score-entry .rank {
            flex-basis: 15%; 
            font-weight: bold;
            color: #64748b; 
            text-align: right; 
            padding-right: 5px;
        }
        .score-entry .player-name {
            flex-basis: 55%; 
            color: #334155; 
            text-align: right; 
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            padding-right: 10px;
        }
        .score-entry .score-value-container { 
            flex-basis: 30%; 
            display: flex;
            justify-content: flex-end; 
            align-items: baseline;
            font-weight: bold;
            color: #0f172a; 
            white-space: nowrap;
        }
        .score-entry .score-unit {
            font-size: 0.9em; 
            color: #475569; 
            margin-right: 5px; 
        }

        .score-entry.rank-1 { background-color: #fef9c3; border-color: #facc15; }
        .score-entry.rank-1 .rank, .score-entry.rank-1 .player-name, .score-entry.rank-1 .score-value, .score-entry.rank-1 .score-unit { color: #ca8a04; font-size: 1.2rem; }
        .score-entry.rank-2 { background-color: #f1f5f9; border-color: #94a3b8; }
        .score-entry.rank-2 .rank, .score-entry.rank-2 .player-name, .score-entry.rank-2 .score-value, .score-entry.rank-2 .score-unit { color: #475569; font-size: 1.15rem; }
        .score-entry.rank-3 { background-color: #fff7ed; border-color: #fb923c; }
        .score-entry.rank-3 .rank, .score-entry.rank-3 .player-name, .score-entry.rank-3 .score-value, .score-entry.rank-3 .score-unit { color: #ea580c; font-size: 1.12rem; }
        
        #no-scores-display-message {
            text-align: center;
            color: #64748b; 
            margin-top: 40px;
            font-size: 1.2rem;
            font-style: italic;
        }
        #back-to-game-button {
            background-color: #10b981; 
            color: white;
            font-weight: bold;
            padding: 12px 25px;
            border-radius: 8px;
            transition: background-color 0.2s ease;
            cursor: pointer;
            font-size: 1.1rem;
            margin-top: 20px; 
        }
        #back-to-game-button:hover {
            background-color: #059669; 
        }


        .spark { /* ... same ... */ }
        @keyframes fly { /* ... same ... */ }
        #milestone-notification {
            position: fixed;
            top: 50px; 
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1.5rem;
            font-weight: bold;
            z-index: 1100;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.5s ease, visibility 0.5s ease;
            pointer-events: none;
            text-align: center; 
        }
        #milestone-notification.visible { 
            opacity: 1; 
            visibility: visible; 
        }

        @keyframes fadeIn { /* ... same ... */ } /* ... other animations ... */
        .anim-fadeIn { animation-name: fadeIn; }
        .anim-slideInDown { animation-name: slideInDown; }
        .anim-slideInUp { animation-name: slideInUp; }
        .anim-slideInLeft { animation-name: slideInLeft; }
        .anim-slideInRight { animation-name: slideInRight; }
        .anim-zoomIn { animation-name: zoomIn; }
        .anim-bounceIn { animation-name: bounceIn; }
        .anim-rubberBand { animation-name: rubberBand; }
    </style>
</head>
<body class="bg-gray-100">
    <nav id="global-nav">
        <a href="#" id="nav-link-game" class="nav-link active-nav">משחק</a>
        <a href="#" id="nav-link-leaderboard" class="nav-link">לוח שיאים</a>
    </nav>

    <audio src="assets/mp3/1.mp3" loop id="background-music"></audio>
    
    <main id="letter-game-page" class="active"> 
        <div class="game-container visible"> 
            <div id="score" class="score-display">0</div>
            <div class="word-card">
                 <div id="correct-word-overlay" class="correct-word-overlay"></div>
                <img id="image-display" class="image-display" src="" alt="Guess the word for this image" >
                <div id="text-display" class="text-display"></div>
            </div>
            <div id="prompt" class="prompt">נחשו את האות הראשונה</div>
            <div class="flex justify-center items-center mb-4"> <button id="hint-button">רמז תמורת חצי נקודה</button> 
                <button id="manual-end-game-button">סיים משחק</button>
            </div>
            <div id="guess-area" class="guess-area" ></div>
            <input type="text" id="hidden-input" class="hidden-input" maxlength="1" autocapitalize="off" autocomplete="off" spellcheck="false">
            <div id="keyboard-area"></div>
        </div>
    </main>

    <main id="word-group-game-page"> 
        <div class="mini-game-container">
            <div id="score-mini-game" class="score-display">0</div> 
            <h1 class="text-3xl font-bold text-slate-700 mb-6">משחקון זיהוי מילים!</h1>
            <p id="mini-game-instruction" class="mb-4">הקשיבו למילה ולחצו על המספר הנכון.</p>
            <button id="play-word-sound-button" class="mb-6">השמע מילה</button>
            <div id="word-group-display"></div>
            <div id="mini-game-feedback" class="mt-4"></div>
            <button id="manual-end-mini-game-button" class="mt-6 bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded">סיים משחקון</button>
        </div>
    </main>

    <main id="leaderboard-page">
        <div class="leaderboard-container">
            <h1>לוח השיאים</h1>
            <div id="high-scores-header"> <span class="header-rank">מיקום</span>
                <span class="header-name">שם</span>
                <span class="header-score">ניקוד</span>
            </div>
            <ul id="high-scores-list-display"></ul>
            <p id="no-scores-display-message" style="display:none;">עדיין אין שיאים רשומים.</p>
            <button id="back-to-game-button">חזרה למשחק</button>
        </div>
    </main>

    <div id="message-overlay" class="overlay"> 
        <div id="spark-container" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;"></div>
        <div class="message-box">
            <h2 id="message-title">Game Over!</h2>
            <p id="message-text">Your final score is...</p>
            <div class="button-group"> 
                <button id="restart-button">Play Again</button>
                <button id="leaderboard-button">לוח שיאים</button>
            </div>
        </div>
    </div>
    <div id="checkpoint-overlay" class="overlay">
        <div class="message-box">
            <p id="checkpoint-message">כל הכבוד! צברת מספיק נקודות. האם תרצו להמשיך למשחקון בונוס?</p>
            <div class="button-group">
                 <button id="checkpoint-continue-button">כן, למשחקון!</button> 
                 <button id="checkpoint-finish-button">לא, סיים משחק</button> 
            </div>
        </div>
    </div>
     <div id="name-prompt-overlay" class="overlay">
         <div class="message-box">
             <p>ברכות! הגעתם לשיא חדש ונכנסתם ללוח התוצאות! נא רשמו את שמכם:</p>
             <input type="text" id="player-name-input" maxlength="15" placeholder="Your Name">
             <button id="submit-name-button">שמור</button> 
         </div>
     </div>
    <div id="milestone-notification">10 Points!!!</div>

    <div id="correct-word-prompt-overlay" class="overlay">
        <div class="message-box">
            <p>המילה הנכונה היא <span id="revealed-word-span"></span>. נא שננו אותה ולחצו על כל מקש כשאתם מוכנים לתרגיל הבא.</p>
        </div>
    </div>


    <script>
        // --- DOM Elements ---
        const navLinkGame = document.getElementById('nav-link-game'); 
        const navLinkLeaderboard = document.getElementById('nav-link-leaderboard'); 

        const letterGamePage = document.getElementById('letter-game-page');
        const wordGroupGamePage = document.getElementById('word-group-game-page');
        const leaderboardPage = document.getElementById('leaderboard-page'); 
        const imageDisplay = document.getElementById('image-display');
        const textDisplay = document.getElementById('text-display');
        const wordCard = document.querySelector('#letter-game-page .word-card');
        const guessArea = document.getElementById('guess-area');
        const hiddenInput = document.getElementById('hidden-input');
        const keyboardArea = document.getElementById('keyboard-area');
        const scoreDisplayLetterGame = document.querySelector('#letter-game-page #score');
        const promptDisplay = document.getElementById('prompt');
        const hintButton = document.getElementById('hint-button'); 
        const manualEndGameButton = document.getElementById('manual-end-game-button'); 
        const correctWordOverlay = document.getElementById('correct-word-overlay');
        const correctWordPromptOverlayElement = document.getElementById('correct-word-prompt-overlay'); 
        const revealedWordSpan = document.getElementById('revealed-word-span'); 

        const scoreDisplayMiniGame = document.querySelector('#word-group-game-page #score-mini-game');
        const miniGameInstruction = document.getElementById('mini-game-instruction');
        const playWordSoundButton = document.getElementById('play-word-sound-button');
        const wordGroupDisplay = document.getElementById('word-group-display');
        const miniGameFeedback = document.getElementById('mini-game-feedback');
        const manualEndMiniGameButton = document.getElementById('manual-end-mini-game-button'); 
        const highScoresListDisplay = document.getElementById('high-scores-list-display'); 
        const noScoresDisplayMessage = document.getElementById('no-scores-display-message'); 
        const backToGameButton = document.getElementById('back-to-game-button'); 
        const bgMusicElement = document.getElementById('background-music'); 
        const messageOverlay = document.getElementById('message-overlay');
        const sparkContainer = document.getElementById('spark-container');
        const messageTitle = document.getElementById('message-title');
        const messageText = document.getElementById('message-text');
        const restartButton = document.getElementById('restart-button');
        const leaderboardButton = document.getElementById('leaderboard-button'); 
        const checkpointOverlay = document.getElementById('checkpoint-overlay');
        const checkpointContinueButton = document.getElementById('checkpoint-continue-button');
        const checkpointFinishButton = document.getElementById('checkpoint-finish-button');
        const namePromptOverlay = document.getElementById('name-prompt-overlay');
        const playerNameInput = document.getElementById('player-name-input');
        const submitNameButton = document.getElementById('submit-name-button');
        const milestoneNotification = document.getElementById('milestone-notification');

        // --- Letter Game Configuration ---
        const letterGameWordData = [ /* ... Same word data ... */ 
             { word: 'elephant', imageUrl: 'https://upload.wikimedia.org/wikipedia/commons/thumb/3/37/African_Bush_Elephant.jpg/1280px-African_Bush_Elephant.jpg' },
            { word: 'egg', imageUrl: 'https://thumbs.dreamstime.com/b/cheerful-animated-egg-character-arms-legs-cheerful-animated-egg-character-features-friendly-face-arms-349677850.jpg?w=768' },
            { word: 'eraser', imageUrl: 'https://thumbs.dreamstime.com/b/transparent-glowing-eraser-animated-erasing-action-sleek-transparent-glowing-eraser-animated-erasing-effect-368891160.jpg?w=768' },
            { word: 'school', imageUrl: 'https://thumbs.dreamstime.com/b/school-activity-vector-illustration-42666092.jpg?w=992' },
            { word: 'pencil', imageUrl: 'https://thumbs.dreamstime.com/b/playful-cartoon-pencil-mascot-happy-expression-ideal-education-creativity-fun-school-projects-354712103.jpg?w=992' },
            { word: 'bed', imageUrl: 'https://thumbs.dreamstime.com/b/bed-icon-flat-design-vector-illustration-retro-style-double-bed-vector-outline-vintage-furniture-icon-flat-design-linear-118463479.jpg?w=768' },
            { word: 'table', imageUrl: 'https://thumbs.dreamstime.com/b/wooden-table-eps-vector-illustration-white-background-transparent-objects-opacity-masks-used-shadows-lights-drawing-35692708.jpg?w=768' },
            { word: 'test', imageUrl: 'https://thumbs.dreamstime.com/b/close-up-look-score-final-exam-paper-red-pen-44378706.jpg?w=768' },
            { word: 'teacher', imageUrl: 'https://thumbs.dreamstime.com/b/animated-illustration-male-teacher-standing-front-chalkboard-wearing-blue-suit-jacket-light-shirt-smiling-366267898.jpg?w=768' },
            { word: 'pen', imageUrl: 'https://thumbs.dreamstime.com/b/red-pen-24495014.jpg?w=768' },
            { word: 'pencil-case', imageUrl: 'https://thumbs.dreamstime.com/b/pencil-case-17588896.jpg?w=768' },
            { word: 'hat', imageUrl: 'https://thumbs.dreamstime.com/b/hat-10595142.jpg?w=768' },
            { word: 'add', displayText: 'לחבר, להוסיף' },
            { word: 'plus', imageUrl: 'https://thumbs.dreamstime.com/b/sign-plus-white-background-12355372.jpg?w=768' },
            { word: 'in', displayText: 'בתוך, ב-' },
            { word: 'on', displayText: 'על' },
            { word: 'pupil', imageUrl: 'https://thumbs.dreamstime.com/b/little-girl-cartoon-studying-illustration-34606556.jpg?w=768' },
            { word: 'picture', imageUrl: 'https://thumbs.dreamstime.com/b/framed-illusion-young-woman-looking-classic-baroque-picture-frame-grunge-textured-wall-landscape-showing-hot-air-116260079.jpg?w=768' },
            { word: 'chair', imageUrl: 'https://thumbs.dreamstime.com/b/wooden-chair-19335760.jpg?w=768' },
            { word: 'lost', displayText: 'אבד' },
            { word: 'ask', displayText: 'לשאול' },
            { word: 'play', imageUrl: 'https://thumbs.dreamstime.com/b/laughing-smiling-kids-sit-floor-circle-play-toy-cubes-talk-children-s-entertainment-preschool-kindergarten-84213751.jpg?w=768' },
            { word: 'sing', imageUrl: 'https://thumbs.dreamstime.com/b/happy-cute-kid-girl-sing-song-166431357.jpg?w=768' },
            { word: 'run', imageUrl: 'https://thumbs.dreamstime.com/b/happy-kid-boy-train-run-marathon-jogging-happy-kid-boy-train-run-marathon-jogging-cute-children-girl-fun-kinder-kindergarten-160914622.jpg?w=768' },
            { word: 'rest', imageUrl: 'https://thumbs.dreamstime.com/b/3d-small-people-rest-chaise-lounge-14119820.jpg?w=768' },
            { word: 'hen', imageUrl: 'https://thumbs.dreamstime.com/b/chicken-hen-cute-posing-illustration-white-background-60511513.jpg?w=768' },
            { word: 'rabbit', imageUrl: 'https://thumbs.dreamstime.com/b/rabbit-illustration-cute-cartoon-65849913.jpg?w=768' },
            { word: 'best', displayText: 'הכי טוב' },
            { word: 'hand', imageUrl: 'https://thumbs.dreamstime.com/b/up-your-hand-18936618.jpg?w=1400' },
            { word: 'horse', imageUrl: 'https://thumbs.dreamstime.com/b/purebred-horse-illustration-chestnut-43286851.jpg?w=768' },
            { word: 'happy', imageUrl: 'https://thumbs.dreamstime.com/b/happy-smiley-emoticon-face-27613930.jpg?w=768' },
            { word: 'good', displayText: 'טוב' },
            { word: 'tall', imageUrl: 'https://upload.wikimedia.org/wikipedia/commons/f/f7/Robert_Wadlow_postcard.jpg' },
            { word: 'fast', displayText: 'מהיר' },
            { word: 'ball', imageUrl: 'https://thumbs.dreamstime.com/b/football-soccer-ball-flat-icon-white-isolated-background-eps-file-available-93721599.jpg?w=768' },
            { word: 'sofa', imageUrl: 'https://thumbs.dreamstime.com/b/sofa-clock-5916545.jpg?w=768' },
            { word: 'sun', imageUrl: 'https://thumbs.dreamstime.com/b/smiling-sun-illustration-character-34434947.jpg?w=768' },
            { word: 'sunny', displayText: 'בהיר, מוצף שמש' },
            { word: 'hot', imageUrl: 'https://thumbs.dreamstime.com/b/hot-bursting-thermometer-illustration-high-temperature-exploding-44252591.jpg?w=768' },
            { word: 'cold', imageUrl: 'https://thumbs.dreamstime.com/b/vector-ice-cold-symbol-illustration-31904919.jpg?w=768' },
            { word: 'living room', imageUrl: 'https://thumbs.dreamstime.com/b/light-living-room-interior-bright-sunny-day-layered-vector-eps-v-enjoy-38719351.jpg?w=768' },
            { word: 'farm', imageUrl: 'https://thumbs.dreamstime.com/b/happy-farm-animals-vector-illustration-living-peacefully-together-barn-background-50639771.jpg?w=768' },
            { word: 'mouse', imageUrl: 'https://thumbs.dreamstime.com/b/cartoon-happy-mouse-waving-illustration-134078893.jpg?w=768' },
            { word: 'sheep', imageUrl: 'https://thumbs.dreamstime.com/b/cute-sheep-14124678.jpg?w=768' },
            { word: 'tree', imageUrl: 'https://thumbs.dreamstime.com/b/palm-tree-shadow-white-vector-30242034.jpg?w=768' },
            { word: 'friend', imageUrl: 'https://thumbs.dreamstime.com/b/care-friend-18171509.jpg?w=768' },
            { word: 'job', displayText: 'עבודה' },
            { word: 'soft', displayText: 'רך' },
            { word: 'fun', displayText: 'כיף, מהנה' },
            { word: 'cow', imageUrl: 'https://thumbs.dreamstime.com/b/cartoon-cow-friendly-expression-59284628.jpg?w=768' },
            { word: 'carrot', imageUrl: 'https://thumbs.dreamstime.com/b/cartoon-carrot-vector-illustration-isolated-white-110455651.jpg?w=768' },
            { word: 'leg', imageUrl: 'https://thumbs.dreamstime.com/b/leg-vector-front-view-illustration-human-legs-composition-113961429.jpg?w=768' },
            { word: 'brown', imageUrl: 'https://thumbs.dreamstime.com/b/chocolate-splash-blot-drops-stain-38516728.jpg?w=768' },
            { word: 'they', displayText: 'הם, הן' },
            { word: 'now', displayText: 'עכשיו' },
            { word: 'hungry', imageUrl: 'https://thumbs.dreamstime.com/b/hungry-emoticon-18251487.jpg?w=768' },
            { word: 'lamp', imageUrl: 'https://thumbs.dreamstime.com/b/lamp-light-bulb-vector-icon-lamp-light-bulb-vector-icon-idea-creative-think-lightbulb-lamp-symbol-115241795.jpg?w=768' },
            { word: 'mat', imageUrl: 'https://thumbs.dreamstime.com/b/flying-rag-rug-carpet-vintage-colorful-like-magic-isolated-vector-illustration-over-white-background-56117568.jpg?w=768' },
            { word: 'milk', imageUrl: 'https://thumbs.dreamstime.com/b/coloring-book-milk-box-children-138603303.jpg?w=768' },
            { word: 'floor', imageUrl: 'https://thumbs.dreamstime.com/b/wood-floor-14838840.jpg?w=1400' },
            { word: 'garden', imageUrl: 'https://thumbs.dreamstime.com/b/cartoon-garden-fruits-vegetables-vector-illustration-fresh-70985624.jpg?w=768' },
            { word: 'kitchen', imageUrl: 'https://thumbs.dreamstime.com/b/vector-cartoon-illustration-kitchen-interior-cozy-modern-dinner-table-household-appliances-fridge-stove-microwave-113675611.jpg?w=768' },
            { word: 'mad', imageUrl: 'https://thumbs.dreamstime.com/b/furious-emoticon-24770560.jpg?w=768' },
            { word: 'lunch', imageUrl: 'https://thumbs.dreamstime.com/b/fast-food-lunch-pizza-hamburgers-hot-dogs-pop-40386346.jpg?w=768' },
            { word: 'juice', imageUrl: 'https://thumbs.dreamstime.com/b/glass-orange-juice-vector-cartoon-56217990.jpg?w=768' },
            { word: 'cookie', imageUrl: 'https://thumbs.dreamstime.com/b/chocolate-chips-cookie-vector-illustration-sweet-food-baking-icon-52699777.jpg?w=768' },
            { word: 'chicken', imageUrl: 'https://thumbs.dreamstime.com/b/roast-turkey-chicken-dinner-plate-traditional-thanksgiving-vector-clip-art-illustration-simple-cartoon-style-isolated-133279135.jpg?w=768' },
            { word: 'car', imageUrl: 'https://thumbs.dreamstime.com/b/american-pony-car-detail-vector-image-black-modern-white-racing-stripes-isolated-white-background-file-contains-31147806.jpg?w=992' },
            { word: 'plan', displayText: 'תכנית' },
            { word: 'sandwich', imageUrl: 'https://thumbs.dreamstime.com/b/appetizing-sandwich-cheese-vegetables-18855790.jpg?w=768' },
        ];
        const animations = ['anim-fadeIn', 'anim-slideInDown', 'anim-slideInUp', 'anim-slideInLeft', 'anim-slideInRight', 'anim-zoomIn', 'anim-bounceIn', 'anim-rubberBand'];
        const totalLetterGameWords = letterGameWordData.length;
        const checkpointScoreInterval = 10; 
        const HIGH_SCORES_KEY = 'wordGuessHighScores';
        const MAX_HIGH_SCORES = 10;

        // --- Mini-Game Configuration ---
        const wordGroupMiniGameData = [
            { words: ["dad", "had", "sad", "sat"] }, { words: ["best", "test", "pest", "past"] },
            { words: ["it", "sit", "hit", "hat"] }, { words: ["has", "hen", "eggs", "the"] },
            { words: ["and", "hand", "sand", "stand"] }, { words: ["him", "hit", "his", "has"] },
            { words: ["map", "man", "mat", "met"] }, { words: ["he", "has", "eggs", "pens"] },
            { words: ["met", "net", "bet", "best"] }, { words: ["cab", "can", "cat", "cast"] },
            { words: ["is", "in", "it", "its"] }
        ];
        let shuffledMiniGameGroups = [];
        let currentMiniGameGroupIndex = 0;
        let currentMiniGameTargetWord = '';
        let miniGameRoundActive = false;
        let originalBgVolume = 1.0; 

        // --- Shared Game State ---
        let score = 0; 
        let backgroundMusicAttempted = false; 
        let isTouchDevice = false;
        let finalScoreToSave = 0;
        let lastCheckpointScore = 0; 
        let waitingForKeyPressAfterReveal = false; 
        let inputLockUntilNextInteraction = false; 

        // --- Letter Game State ---
        let currentLetterGameWordIndex = 0;
        let letterGame_currentWord = ''; 
        let letterGame_displayedGuess = [];
        let letterGame_guessingStage = 'first';
        let letterGame_firstLetterCorrect = false;
        let letterGame_lastLetterCorrect = false;
        let letterGame_listeningForInput = true;
        let letterGame_hintUsedForCurrentWord = false;
        let letterGame_scoreFlashTimeout = null;

        const synth = window.speechSynthesis;
        let speechUtterance;

        function shuffleArray(array) { 
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }
        function detectTouch() { 
             isTouchDevice = ('ontouchstart' in window) || (navigator.maxTouchPoints > 0) || (navigator.msMaxTouchPoints > 0);
             if (isTouchDevice) {
                 document.body.classList.add('touch-device');
                 document.body.classList.remove('no-touch-device');
             } else {
                 document.body.classList.add('no-touch-device');
                 document.body.classList.remove('touch-device');
             }
        }
        function tryStartBackgroundMusic() { 
            if (bgMusicElement && !backgroundMusicAttempted && bgMusicElement.paused) {
                bgMusicElement.volume = 0.5; 
                originalBgVolume = bgMusicElement.volume; 
                console.log("Attempting to play background music due to user interaction...");
                bgMusicElement.play()
                    .then(() => {
                        console.log("Background music playback started.");
                        backgroundMusicAttempted = true; 
                    })
                    .catch(error => {
                        console.error("Error attempting to play background music:", error);
                        backgroundMusicAttempted = true; 
                    });
            } else if (bgMusicElement && bgMusicElement.paused === false) {
                backgroundMusicAttempted = true; 
            }
        }
        
        function showPage(pageId) {
            document.querySelectorAll('main').forEach(page => page.classList.remove('active'));
            document.querySelectorAll('#global-nav .nav-link').forEach(link => link.classList.remove('active-nav'));

            const targetPage = document.getElementById(pageId);
            if (targetPage) targetPage.classList.add('active');

            if (pageId === 'leaderboard-page') {
                if(navLinkLeaderboard) navLinkLeaderboard.classList.add('active-nav');
                displayHighScores(); 
            } else if (pageId === 'letter-game-page' || pageId === 'word-group-game-page') {
                 if(navLinkGame) navLinkGame.classList.add('active-nav');
            }
            updateScoreDisplays(); 
            updateManualEndGameButtonVisibility(); 
        }

        function updateScoreDisplays() {
            const scoreToDisplay = score % 1 === 0 ? score : score.toFixed(1); 
            if(scoreDisplayLetterGame) scoreDisplayLetterGame.textContent = `${scoreToDisplay}`;
            if(scoreDisplayMiniGame) scoreDisplayMiniGame.textContent = `${scoreToDisplay}`;
            
            const maxScorePossibleOverall = (totalLetterGameWords * 2) + wordGroupMiniGameData.length;
            const percentage = maxScorePossibleOverall > 0 ? (score / maxScorePossibleOverall) * 100 : 0;
            const hue = Math.min(120, percentage * 1.2); 
            if(scoreDisplayLetterGame) scoreDisplayLetterGame.style.color = `hsl(${hue}, 100%, 40%)`;
            if(scoreDisplayMiniGame) scoreDisplayMiniGame.style.color = `hsl(${hue}, 100%, 40%)`;
        }


        // --- LETTER GUESSING GAME ---
        function initializeLetterGame(continueFromPrevious = false) {
            console.log("Initializing Letter Game state. Continue from previous:", continueFromPrevious);
            if (!continueFromPrevious) {
                currentLetterGameWordIndex = 0; 
            }
            letterGame_hintUsedForCurrentWord = false; 
            detectTouch(); 
            if (!continueFromPrevious) shuffleArray(letterGameWordData); 
            
            letterGame_guessingStage = 'first';
            letterGame_firstLetterCorrect = false; letterGame_lastLetterCorrect = false; 
            messageOverlay.classList.remove('visible');
            checkpointOverlay.classList.remove('visible'); 
            namePromptOverlay.classList.remove('visible'); 
            correctWordPromptOverlayElement.classList.remove('visible'); 
            sparkContainer.innerHTML = ''; 
            scoreDisplayLetterGame.classList.remove('visible', 'score-flash');
            if (letterGame_scoreFlashTimeout) clearTimeout(letterGame_scoreFlashTimeout);
            updateScoreDisplays(); 
            if (isTouchDevice) createLetterGameKeyboard();
            else { keyboardArea.innerHTML = ''; keyboardArea.classList.remove('visible'); }
            
            letterGame_listeningForInput = true; 
            waitingForKeyPressAfterReveal = false; 
            inputLockUntilNextInteraction = false; 
            loadLetterGameWord(); 
            
            hiddenInput.removeEventListener('input', handleLetterGameTextInput);
            hiddenInput.addEventListener('input', handleLetterGameTextInput);
            const focusTrigger = isTouchDevice ? 'touchstart' : 'click';
            guessArea.removeEventListener(focusTrigger, focusLetterGameHiddenInput);
            guessArea.addEventListener(focusTrigger, focusLetterGameHiddenInput);
            promptDisplay.removeEventListener(focusTrigger, focusLetterGameHiddenInput);
            promptDisplay.addEventListener(focusTrigger, focusLetterGameHiddenInput);
            console.log("Letter Game initialization complete.");
            showPage('letter-game-page');
        }

        function createLetterGameKeyboard() { 
            keyboardArea.innerHTML = ''; 
            const rows = [ "qwertyuiop", "asdfghjkl", "zxcvbnm" ];
            rows.forEach(rowString => {
                const rowDiv = document.createElement('div');
                rowDiv.classList.add('keyboard-row');
                rowString.split('').forEach(letter => {
                    const button = document.createElement('button');
                    button.textContent = letter.toUpperCase();
                    button.dataset.key = letter; 
                    button.addEventListener('click', () => handleLetterGameOnScreenKeyPress(letter));
                    rowDiv.appendChild(button);
                });
                keyboardArea.appendChild(rowDiv);
            });
            keyboardArea.classList.add('visible'); 
            animateLetterGameKeyboardIntro();
        }
        function animateLetterGameKeyboardIntro() { 
            const sequence = ['m', 'i', 'l', 'e', 'y'];
            const highlightDuration = 300; 
            const finalDelay = 2000; 
            sequence.forEach((letter, index) => {
                setTimeout(() => {
                    const keyButton = keyboardArea.querySelector(`button[data-key="${letter}"]`);
                    if (keyButton) keyButton.classList.add('key-highlight');
                }, index * highlightDuration);
            });
            setTimeout(() => {
                const highlightedKeys = keyboardArea.querySelectorAll('.key-highlight');
                highlightedKeys.forEach(key => key.classList.remove('key-highlight'));
            }, sequence.length * highlightDuration + finalDelay);
        }

        function updateLetterGameHintButtonState() { 
            if (!hintButton) return;
            const canShowHint = letterGame_currentWord.length > 2 && !letterGame_hintUsedForCurrentWord && letterGame_guessingStage !== 'done' && letterGame_listeningForInput;
            hintButton.disabled = !canShowHint;
            hintButton.style.display = letterGame_listeningForInput && letterGame_guessingStage !== 'done' ? 'inline-block' : 'none';
        }
        
        function focusLetterGameHiddenInput() { 
            if (waitingForKeyPressAfterReveal || inputLockUntilNextInteraction) return; 
            tryStartBackgroundMusic(); 
            if (letterGame_listeningForInput && letterGame_guessingStage !== 'done' && !isTouchDevice) {
                hiddenInput.focus();
            } else if (isTouchDevice && document.activeElement === hiddenInput) {
                hiddenInput.blur();
            }
        }

        function updateLetterGameGuessArea() {
            guessArea.innerHTML = '';
            letterGame_displayedGuess.forEach((letter, index) => {
                const slot = document.createElement('span');
                slot.classList.add('guess-slot');
                slot.textContent = letter; 

                slot.classList.remove('correct', 'incorrect', 'active-guess'); 

                if (index === 0) { 
                    if (letterGame_guessingStage === 'last' || letterGame_guessingStage === 'done') { 
                        if (letterGame_firstLetterCorrect) {
                            slot.classList.add('correct');
                        } else {
                            slot.classList.add('incorrect'); 
                        }
                    }
                } else if (index === letterGame_currentWord.length - 1) { 
                    if (letterGame_guessingStage === 'done') { 
                        if (letterGame_lastLetterCorrect) {
                            slot.classList.add('correct');
                        } else {
                            slot.classList.add('incorrect'); 
                        }
                    }
                }

                if (letterGame_listeningForInput && letterGame_guessingStage !== 'done') {
                    if (letterGame_guessingStage === 'first' && index === 0) {
                        slot.classList.remove('correct', 'incorrect'); 
                        slot.classList.add('active-guess');
                    } else if (letterGame_guessingStage === 'last' && index === (letterGame_currentWord.length - 1)) {
                        if (letterGame_displayedGuess[index] === '_') { 
                           slot.classList.remove('correct', 'incorrect'); 
                           slot.classList.add('active-guess');
                        }
                    }
                }
                guessArea.appendChild(slot);
            });
        }

        function loadLetterGameWord() {
            if (hiddenInput) hiddenInput.value = ''; 
            letterGame_listeningForInput = false; 
            waitingForKeyPressAfterReveal = false; 
            inputLockUntilNextInteraction = false; // Reset lock here

            if (currentLetterGameWordIndex >= totalLetterGameWords) { 
                handleOverallGameEnd("כל הכבוד! סיימת את כל המילים במשחק הניחוש!"); 
                return; 
            }
            const currentData = letterGameWordData[currentLetterGameWordIndex];
            if (!currentData || !currentData.word) { currentLetterGameWordIndex++; loadLetterGameWord(); return; }
            
            letterGame_currentWord = currentData.word.toLowerCase();
            letterGame_firstLetterCorrect = false; 
            letterGame_lastLetterCorrect = false;  
            letterGame_guessingStage = 'first';   
            letterGame_hintUsedForCurrentWord = false; 
            letterGame_displayedGuess = Array(letterGame_currentWord.length).fill('_'); 

            console.log(`loadLetterGameWord: Reset state for '${letterGame_currentWord}'. Stage: ${letterGame_guessingStage}, FirstCorrect: ${letterGame_firstLetterCorrect}`);

            promptDisplay.textContent = `נחשו את האות הראשונה`;
            correctWordOverlay.style.display = 'none'; correctWordOverlay.textContent = '';
            
            updateLetterGameGuessArea(); 
            
            const randomAnimation = animations[Math.floor(Math.random() * animations.length)];
            imageDisplay.className = 'image-display'; textDisplay.className = 'text-display';
            imageDisplay.style.display = 'none'; textDisplay.style.display = 'none';
            imageDisplay.onerror = null;
            if (currentData.displayText) {
                textDisplay.textContent = currentData.displayText; textDisplay.style.display = 'block';
                setTimeout(() => textDisplay.classList.add(randomAnimation), 10);
            } else if (currentData.imageUrl) {
                imageDisplay.onerror = function() { handleLetterGameImageError(this, letterGame_currentWord); };
                imageDisplay.src = currentData.imageUrl; imageDisplay.style.display = 'block';
                setTimeout(() => imageDisplay.classList.add(randomAnimation), 10);
            } else {
                 textDisplay.textContent = `No content for "${letterGame_currentWord}"`; textDisplay.classList.add('fallback');
                 textDisplay.style.display = 'block'; setTimeout(() => textDisplay.classList.add(randomAnimation), 10);
            }
            if(wordCard) wordCard.style.boxShadow = '0 10px 20px rgba(0, 0, 0, 0.1)';
            updateScoreDisplays(); 
            
            setTimeout(() => { 
                letterGame_listeningForInput = true; 
                updateLetterGameGuessArea(); 
                updateLetterGameHintButtonState(); 
                updateManualEndGameButtonVisibility();
                if (!isTouchDevice) {
                    focusLetterGameHiddenInput(); 
                }
                console.log("Input listening enabled for new word after delay in loadLetterGameWord.");
            }, 100); // Increased delay
        }

        function handleLetterGameImageError(imgElement, word) { 
            imgElement.style.display = 'none'; imgElement.className = 'image-display';
            textDisplay.textContent = `Image for "${word}" not found`;
            textDisplay.className = 'text-display fallback'; textDisplay.style.display = 'block';
            const randomAnimation = animations[Math.floor(Math.random() * animations.length)];
            setTimeout(() => { if (textDisplay) textDisplay.classList.add(randomAnimation); }, 10);
        }
        
        function flashScore_LetterGame() { 
            if(letterGame_scoreFlashTimeout) clearTimeout(letterGame_scoreFlashTimeout);
            if(scoreDisplayLetterGame) {
                scoreDisplayLetterGame.classList.remove('score-flash');
                void scoreDisplayLetterGame.offsetWidth; 
                scoreDisplayLetterGame.classList.add('visible', 'score-flash');
                letterGame_scoreFlashTimeout = setTimeout(() => scoreDisplayLetterGame.classList.remove('visible', 'score-flash'), 1500);
            }
        }
        
        function handleLetterGameTextInput(event) { 
            if (waitingForKeyPressAfterReveal || inputLockUntilNextInteraction || !letterGame_listeningForInput) {
                if (event && event.target) event.target.value = '';
                return;
            }
            tryStartBackgroundMusic(); 
            if (letterGame_guessingStage === 'done') { // Double check, should be caught by listeningForInput
                if (event && event.target) event.target.value = '';
                return;
            }
            const guessedLetter = event.target.value.toLowerCase();
            if (event && event.target) event.target.value = ''; 
            
            if (guessedLetter.length === 1 && guessedLetter.match(/[a-z]/i)) {
                 processLetterGameGuess(guessedLetter);
            }
        }
        function handleLetterGameOnScreenKeyPress(letter) { 
             if (waitingForKeyPressAfterReveal || inputLockUntilNextInteraction || !letterGame_listeningForInput) return;
             tryStartBackgroundMusic(); 
             if (letterGame_guessingStage === 'done') return;
             processLetterGameGuess(letter.toLowerCase());
        }

        function processLetterGameGuess(guessedLetter) {
            if (waitingForKeyPressAfterReveal || inputLockUntilNextInteraction || !letterGame_listeningForInput) return;
            let pointsThisTurn = 0;
             if (letterGame_guessingStage === 'first') {
                const firstLetter = letterGame_currentWord[0];
                const correct = guessedLetter === firstLetter;
                if (correct) {
                    letterGame_displayedGuess[0] = firstLetter; 
                    letterGame_firstLetterCorrect = true; 
                    pointsThisTurn++;
                } else {
                    letterGame_firstLetterCorrect = false; 
                }
                
                letterGame_guessingStage = 'last'; 
                promptDisplay.textContent = 'נחשו את האות האחרונה'; 
                updateLetterGameGuessArea(); 
                updateLetterGameHintButtonState(); 
                if (!isTouchDevice) focusLetterGameHiddenInput();

            } else if (letterGame_guessingStage === 'last') {
                const lastLetter = letterGame_currentWord[letterGame_currentWord.length - 1];
                const lastIndex = letterGame_currentWord.length - 1;
                const correct = guessedLetter === lastLetter;
                let showCorrectWordFlag = false; 
                if (correct) {
                    letterGame_displayedGuess[lastIndex] = lastLetter; 
                    letterGame_lastLetterCorrect = true; 
                    pointsThisTurn++;
                } else {
                    letterGame_lastLetterCorrect = false; 
                }
                
                letterGame_guessingStage = 'done'; 
                letterGame_listeningForInput = false; 
                updateLetterGameGuessArea(); 
                updateLetterGameHintButtonState(); 
                updateManualEndGameButtonVisibility();


                if (!letterGame_firstLetterCorrect || !letterGame_lastLetterCorrect) {
                     correctWordOverlay.textContent = letterGame_currentWord;
                     correctWordOverlay.style.display = 'block';
                     if(wordCard) wordCard.style.boxShadow = '0 0 15px 5px rgba(248, 113, 113, 0.7)'; 
                     showCorrectWordFlag = true; 
                } else if (wordCard) wordCard.style.boxShadow = '0 0 15px 5px rgba(74, 222, 128, 0.7)'; 
                
                score += pointsThisTurn; 
                updateScoreDisplays();
                if (pointsThisTurn > 0) flashScore_LetterGame();

                if (showCorrectWordFlag) {
                    showCorrectWordAndWait(); 
                } else {
                    if (score >= lastCheckpointScore + checkpointScoreInterval && currentLetterGameWordIndex < totalLetterGameWords -1 ) {
                        lastCheckpointScore = Math.floor(score / checkpointScoreInterval) * checkpointScoreInterval;
                        showCheckpointPrompt(); 
                    } else {
                        currentLetterGameWordIndex++; 
                        setTimeout(() => { loadLetterGameWord(); }, 1200); 
                    }
                }
            }
        }

        function showCorrectWordAndWait() {
            letterGame_listeningForInput = false; 
            waitingForKeyPressAfterReveal = true;
            inputLockUntilNextInteraction = true; 
            updateLetterGameHintButtonState();
            updateManualEndGameButtonVisibility();
            if (revealedWordSpan) revealedWordSpan.textContent = letterGame_currentWord; 
            if (correctWordPromptOverlayElement) correctWordPromptOverlayElement.classList.add('visible');

            document.addEventListener('keydown', proceedAfterWordRevealHandler, { once: true });
        }
        
        // Renamed to avoid conflict with any potential global proceedAfterWordReveal
        function proceedAfterWordRevealHandler(event) { 
            if (!waitingForKeyPressAfterReveal) return; 
            // event.preventDefault(); // Optional: if you want to prevent default key action
            // event.stopPropagation(); // Optional: if you want to stop event bubbling

            console.log("Proceeding after word reveal (keydown).");
            
            if (correctWordPromptOverlayElement) correctWordPromptOverlayElement.classList.remove('visible');
            waitingForKeyPressAfterReveal = false; 
            // inputLockUntilNextInteraction remains true, will be reset by loadLetterGameWord

            // Short delay before loading next word to ensure event queue is clear
            // and to give a moment for the user to process the key press was for the prompt
            setTimeout(() => {
                if (score >= lastCheckpointScore + checkpointScoreInterval && currentLetterGameWordIndex < totalLetterGameWords - 1 ) {
                    lastCheckpointScore = Math.floor(score / checkpointScoreInterval) * checkpointScoreInterval;
                    showCheckpointPrompt(); 
                } else {
                    currentLetterGameWordIndex++; 
                    loadLetterGameWord(); 
                }
            }, 50); 
        }


        function provideLetterGameHint() { 
            if (letterGame_hintUsedForCurrentWord || letterGame_currentWord.length <= 2 || letterGame_guessingStage === 'done' || !letterGame_listeningForInput) {
                updateLetterGameHintButtonState(); return;
            }
            score -= 0.5; 
            updateScoreDisplays(); 
            for (let i = 1; i < letterGame_currentWord.length - 1; i++) {
                letterGame_displayedGuess[i] = letterGame_currentWord[i];
            }
            updateLetterGameGuessArea(); 
            letterGame_hintUsedForCurrentWord = true;
            updateLetterGameHintButtonState(); 
            if ((letterGame_guessingStage === 'first' || letterGame_guessingStage === 'last') && !isTouchDevice) {
                hiddenInput.focus();
            }
        }
        
        // --- WORD GROUP MINI-GAME ---
        function startWordGroupGame() {
            console.log("Starting Word Group Mini-Game...");
            letterGame_listeningForInput = false; 
            updateLetterGameHintButtonState(); 
            
            shuffledMiniGameGroups = [...wordGroupMiniGameData];
            shuffleArray(shuffledMiniGameGroups);
            currentMiniGameGroupIndex = 0;
            miniGameRoundActive = true;
            updateScoreDisplays(); 
            loadWordGroup();
            showPage('word-group-game-page');
        }

        function loadWordGroup() {
            if (currentMiniGameGroupIndex >= shuffledMiniGameGroups.length) {
                endWordGroupGame();
                return;
            }
            miniGameRoundActive = true;
            playWordSoundButton.disabled = false;
            miniGameFeedback.textContent = '';
            miniGameFeedback.className = 'mt-4'; 

            const groupData = shuffledMiniGameGroups[currentMiniGameGroupIndex];
            const wordsInGroup = [...groupData.words]; 
            
            currentMiniGameTargetWord = groupData.words[Math.floor(Math.random() * groupData.words.length)];
            console.log("Mini-game target word:", currentMiniGameTargetWord);

            wordGroupDisplay.innerHTML = '';
            wordsInGroup.forEach((word, index) => {
                const item = document.createElement('div');
                item.classList.add('word-group-item', 'p-3', 'rounded-lg', 'shadow', 'bg-white', 'cursor-pointer', 'hover:bg-blue-100', 'transition-all');
                item.innerHTML = `<span class="word-group-item-text text-xl">${word}</span><span class="word-group-item-number font-bold text-blue-600 ml-3">${index + 1}</span>`;
                item.dataset.word = word;
                item.dataset.index = index;
                item.addEventListener('click', () => handleWordGroupGuess(word, item));
                wordGroupDisplay.appendChild(item);
            });
            miniGameInstruction.textContent = "הקשיבו למילה ולחצו על המילה הנכונה:";
            updateManualEndGameButtonVisibility();
        }

        function playTargetWordSound() {
            if (!currentMiniGameTargetWord || synth.speaking || !bgMusicElement) return;
            tryStartBackgroundMusic(); 

            originalBgVolume = bgMusicElement.volume;
            if (!bgMusicElement.paused && bgMusicElement.volume > 0.05) { 
                bgMusicElement.volume = Math.max(0.05, originalBgVolume * 0.2); 
                console.log(`BG music volume lowered to ${bgMusicElement.volume}`);
            }

            speechUtterance = new SpeechSynthesisUtterance(currentMiniGameTargetWord);
            speechUtterance.lang = 'en-US'; 
            speechUtterance.rate = 0.5; 
            speechUtterance.pitch = 1.1;
            
            speechUtterance.onstart = () => {
                console.log("Speech started for:", currentMiniGameTargetWord);
                playWordSoundButton.disabled = true; 
            };
            
            speechUtterance.onend = () => {
                console.log("Speech ended.");
                if(miniGameRoundActive) playWordSoundButton.disabled = false; 
                if (!bgMusicElement.paused) {
                    bgMusicElement.volume = originalBgVolume;
                    console.log(`BG music volume restored to ${bgMusicElement.volume}`);
                }
            };
            
            speechUtterance.onerror = (event) => {
                console.error("Speech synthesis error:", event.error);
                if(miniGameRoundActive) playWordSoundButton.disabled = false;
                if (!bgMusicElement.paused) {
                    bgMusicElement.volume = originalBgVolume;
                     console.log(`BG music volume restored (on error) to ${bgMusicElement.volume}`);
                }
            };
            synth.speak(speechUtterance);
        }

        function handleWordGroupGuess(guessedWord, clickedItem) {
            if (!miniGameRoundActive) return;
            miniGameRoundActive = false; 
            playWordSoundButton.disabled = true;

            const correct = guessedWord.toLowerCase() === currentMiniGameTargetWord.toLowerCase();
            
            document.querySelectorAll('#word-group-display .word-group-item').forEach(item => {
                item.style.pointerEvents = 'none'; 
            });

            if (correct) {
                score++;
                updateScoreDisplays();
                miniGameFeedback.textContent = "נכון מאוד! כל הכבוד!";
                miniGameFeedback.className = 'mt-4 feedback-correct';
                clickedItem.classList.add('correct-mini-game');
            } else {
                miniGameFeedback.textContent = `טעות. המילה הנכונה היא: ${currentMiniGameTargetWord}`;
                miniGameFeedback.className = 'mt-4 feedback-incorrect';
                clickedItem.classList.add('incorrect-mini-game');
                const correctItems = Array.from(wordGroupDisplay.children).filter(child => child.dataset.word.toLowerCase() === currentMiniGameTargetWord.toLowerCase());
                correctItems.forEach(item => item.classList.add('correct-mini-game'));
            }

            currentMiniGameGroupIndex++;
            setTimeout(() => {
                 document.querySelectorAll('#word-group-display .word-group-item').forEach(item => {
                    item.style.pointerEvents = 'auto'; 
                });
                loadWordGroup();
            }, 2500); 
        }
        
        function endWordGroupGame() {
            console.log("Word Group Mini-Game Ended. Returning to Letter Game.");
            miniGameRoundActive = false;
            initializeLetterGame(true); 
        }


        // --- SHARED GAME FLOW & UI ---
        function showMilestoneNotification(points) { 
            const pointsToShow = points % 1 === 0 ? points : points.toFixed(1);
            milestoneNotification.textContent = `${pointsToShow} Points!!! 🎉`;
            milestoneNotification.classList.add('visible');
            setTimeout(() => milestoneNotification.classList.remove('visible'), 2500); 
        }
        function showCheckpointPrompt() { 
            letterGame_listeningForInput = false; 
            updateLetterGameHintButtonState(); 
            updateManualEndGameButtonVisibility();
            checkpointOverlay.classList.add('visible');
        }
        function handleCheckpointContinue() { 
            checkpointOverlay.classList.remove('visible'); 
            startWordGroupGame();
        }
        function handleCheckpointFinish() { 
             checkpointOverlay.classList.remove('visible'); 
             handleOverallGameEnd("סיימת את המשחק."); 
        }
        function createSparks() { 
            sparkContainer.innerHTML = ''; 
            const sparkCount = 50; 
            for (let i = 0; i < sparkCount; i++) {
                const spark = document.createElement('div'); spark.classList.add('spark');
                const startX = 50 + (Math.random() - 0.5) * 20; 
                const startY = 50 + (Math.random() - 0.5) * 20; 
                spark.style.left = `${startX}%`; spark.style.top = `${startY}%`;
                const angle = Math.random() * Math.PI * 2;
                const distance = 100 + Math.random() * 150; 
                const endX = Math.cos(angle) * distance; const endY = Math.sin(angle) * distance;
                spark.style.setProperty('--tx', `${endX}px`); spark.style.setProperty('--ty', `${endY}px`);
                const hue = 35 + Math.random() * 25; 
                spark.style.backgroundColor = `hsl(${hue}, 100%, 50%)`;
                sparkContainer.appendChild(spark);
                spark.addEventListener('animationend', () => spark.remove());
            }
        }
        
        function handleOverallGameEnd(customMessage = "") { 
            letterGame_listeningForInput = false; 
            miniGameRoundActive = false;
            if(keyboardArea) keyboardArea.classList.remove('visible'); 
            if(scoreDisplayLetterGame) scoreDisplayLetterGame.classList.remove('visible', 'score-flash');
            if(scoreDisplayMiniGame) scoreDisplayMiniGame.classList.remove('visible'); 
            if (letterGame_scoreFlashTimeout) clearTimeout(letterGame_scoreFlashTimeout);
            updateLetterGameHintButtonState(); 
            updateManualEndGameButtonVisibility();
            updateScoreDisplays(); 

            finalScoreToSave = score; 
            if (checkIfHighScore(finalScoreToSave)) {
                showNamePrompt(); 
            } else {
                showGameOverMessage(customMessage); 
            }
        }
        
        function handleManualGameEnd() {
            console.log("Manual game end triggered.");
            handleOverallGameEnd("המשחק הסתיים לבקשתך.");
        }

        function updateManualEndGameButtonVisibility() {
            const isLetterGameActive = letterGamePage.classList.contains('active') && letterGame_listeningForInput;
            const isMiniGameActive = wordGroupGamePage.classList.contains('active') && miniGameRoundActive;

            if (manualEndGameButton) {
                manualEndGameButton.style.display = isLetterGameActive ? 'inline-block' : 'none';
            }
            if (manualEndMiniGameButton) {
                 manualEndMiniGameButton.style.display = isMiniGameActive ? 'inline-block' : 'none';
            }
        }


        function checkIfHighScore(currentScore) { 
             const highScores = loadHighScores();
             return highScores.length < MAX_HIGH_SCORES || currentScore > (highScores[MAX_HIGH_SCORES - 1]?.score ?? 0);
        }
        function showNamePrompt() { 
             letterGame_listeningForInput = false; miniGameRoundActive = false;
             updateLetterGameHintButtonState(); 
             updateManualEndGameButtonVisibility();
             playerNameInput.value = ''; 
             namePromptOverlay.classList.add('visible');
             setTimeout(() => playerNameInput.focus(), 100);
        }
        function handleNameSubmit() { 
             const playerName = playerNameInput.value.trim() || "Anonymous"; 
             saveHighScore(playerName, finalScoreToSave); 
             namePromptOverlay.classList.remove('visible');
             showGameOverMessage(); 
        }
        function showGameOverMessage(customMessage = "") { 
            letterGame_listeningForInput = false; miniGameRoundActive = false;
            updateLetterGameHintButtonState(); 
            updateManualEndGameButtonVisibility();
            const maxLetterGameScore = totalLetterGameWords * 2;
            const percentageOfLetterGame = maxLetterGameScore > 0 ? (score / maxLetterGameScore) * 100 : 0; 
            let finalMessageText = customMessage;
            const scoreToDisplayInMessage = finalScoreToSave % 1 === 0 ? finalScoreToSave : finalScoreToSave.toFixed(1);


            if (!customMessage) { 
                if (percentageOfLetterGame < 50) finalMessageText = "נסו שוב";
                else if (percentageOfLetterGame <= 74) finalMessageText = "מאמץ יפה המשיכו אני מזהה את הפוטנציאל";
                else if (percentageOfLetterGame <= 89) finalMessageText = "אתם מצויינים עוד קצת ואתם בפסגה";
                else { finalMessageText = "מושלם אתם אשפי האנגלית"; createSparks(); }
            } else {
                 if (score >= (maxLetterGameScore + wordGroupMiniGameData.length * 0.8)) createSparks(); 
            }

            messageTitle.textContent = "Game Over!";
            messageText.textContent = `Your final score: ${scoreToDisplayInMessage}. ${finalMessageText}`;
            messageOverlay.classList.add('visible');
        }
        
        function displayHighScores() {
            const scores = loadHighScores();
            highScoresListDisplay.innerHTML = ''; 

            if (scores.length === 0) {
                noScoresDisplayMessage.style.display = 'block';
            } else {
                noScoresDisplayMessage.style.display = 'none';
                scores.forEach((scoreItem, index) => {
                    const li = document.createElement('li');
                    li.classList.add('score-entry');
                    if (index < 3) { 
                        li.classList.add(`rank-${index + 1}`);
                    }
                    
                    const rankSpan = document.createElement('span');
                    rankSpan.classList.add('rank');
                    rankSpan.textContent = `${index + 1}.`;

                    const nameSpan = document.createElement('span');
                    nameSpan.classList.add('player-name');
                    nameSpan.textContent = scoreItem.name;
                    
                    const scoreContainerSpan = document.createElement('span'); 
                    scoreContainerSpan.classList.add('score-value-container');

                    const scoreValueSpan = document.createElement('span');
                    scoreValueSpan.classList.add('score-value');
                    scoreValueSpan.textContent = scoreItem.score % 1 === 0 ? scoreItem.score : scoreItem.score.toFixed(1);

                    const scoreUnitSpan = document.createElement('span');
                    scoreUnitSpan.classList.add('score-unit');
                    scoreUnitSpan.textContent = 'נקודות';
                    
                    scoreContainerSpan.appendChild(scoreValueSpan);
                    scoreContainerSpan.appendChild(scoreUnitSpan);

                    li.appendChild(rankSpan);
                    li.appendChild(nameSpan);
                    li.appendChild(scoreContainerSpan);
                    highScoresListDisplay.appendChild(li);
                });
            }
        }

        function loadHighScores() { 
            try {
                const scoresJSON = localStorage.getItem(HIGH_SCORES_KEY);
                return scoresJSON ? JSON.parse(scoresJSON) : [];
            } catch (error) { console.error("Error loading high scores:", error); return []; }
        }
        function saveHighScore(name, newScore) { 
            if (typeof newScore !== 'number' || newScore < 0) return; 
            try {
                const scores = loadHighScores();
                scores.push({ name: name, score: newScore }); 
                scores.sort((a, b) => b.score - a.score); 
                localStorage.setItem(HIGH_SCORES_KEY, JSON.stringify(scores.slice(0, MAX_HIGH_SCORES)));
            } catch (error) { console.error("Error saving high score:", error); }
        }

        // --- Event Listeners ---
        restartButton.addEventListener('click', () => {
            currentLetterGameWordIndex = 0; 
            score = 0; 
            lastCheckpointScore = 0; 
            initializeLetterGame();
        });
        if (hintButton) { 
            hintButton.addEventListener('click', provideLetterGameHint); 
        }
        if (manualEndGameButton) {
            manualEndGameButton.addEventListener('click', handleManualGameEnd);
        }
        if (manualEndMiniGameButton) {
            manualEndMiniGameButton.addEventListener('click', () => {
                handleOverallGameEnd("המשחק הסתיים לבקשתך.");
            });
        }

        if (playWordSoundButton) {
            playWordSoundButton.addEventListener('click', playTargetWordSound);
        }
        if (leaderboardButton) {
            leaderboardButton.addEventListener('click', () => {
                messageOverlay.classList.remove('visible'); 
                displayHighScores();
                showPage('leaderboard-page');
            });
        }
        if (backToGameButton) {
            backToGameButton.addEventListener('click', () => {
                currentLetterGameWordIndex = 0; 
                score = 0; 
                lastCheckpointScore = 0;
                initializeLetterGame(); 
            });
        }
        if(navLinkGame) {
            navLinkGame.addEventListener('click', (e) => {
                e.preventDefault();
                messageOverlay.classList.remove('visible');
                checkpointOverlay.classList.remove('visible');
                namePromptOverlay.classList.remove('visible');
                correctWordPromptOverlayElement.classList.remove('visible');


                currentLetterGameWordIndex = 0; 
                score = 0; 
                lastCheckpointScore = 0;
                initializeLetterGame(); 
            });
        }
        if(navLinkLeaderboard) {
            navLinkLeaderboard.addEventListener('click', (e) => {
                e.preventDefault();
                messageOverlay.classList.remove('visible');
                checkpointOverlay.classList.remove('visible');
                namePromptOverlay.classList.remove('visible');
                correctWordPromptOverlayElement.classList.remove('visible');
                
                displayHighScores();
                showPage('leaderboard-page');
            });
        }


        window.onload = () => {
            checkpointContinueButton.addEventListener('click', handleCheckpointContinue);
            checkpointFinishButton.addEventListener('click', handleCheckpointFinish);
            submitNameButton.addEventListener('click', handleNameSubmit);
            
            console.log("Page loaded, initializing game UI.");
            currentLetterGameWordIndex = 0; 
            score = 0; 
            lastCheckpointScore = 0;
            initializeLetterGame(); 
        };
    </script>

</body>
</html>
